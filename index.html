<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>三角比クイズ | Material Design</title>
<style>
  :root {
    --md-sys-color-primary: #1E88E5;
    --md-sys-color-outline: #E0E0E0;
    --md-sys-color-success: #43A047;
    --md-sys-color-error: #E53935;
    --font-display: 'Roboto Flex', 'Noto Sans JP', system-ui, sans-serif;
  }
  body { margin:0; padding:0; background:#FAFAFA; font-family:var(--font-display); display:flex; justify-content:center; align-items:center; min-height:100vh; }
  .container { background:white; border-radius:24px; box-shadow:0 4px 12px rgba(0,0,0,0.15); padding:40px 48px; width:min(95vw,1000px); border:1px solid var(--md-sys-color-outline); }

  /* ====== セットアップ画面 ====== */
  .setup-screen { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:40px; padding:8px 0; text-align:center; }
  .setup-hero { text-align:center; }
  .setup-title { font-size:56px; color:#1E88E5; margin:0; font-weight:900; letter-spacing:-0.02em; }
  .setup-sub { font-size:18px; color:#607D8B; margin-top:6px; }

  .setup-card { width:min(92vw,800px); background:linear-gradient(135deg,#ffffff 0%, #f7fbff 40%, #eef6ff 100%); border:1px solid var(--md-sys-color-outline); border-radius:28px; box-shadow:0 10px 28px rgba(30,136,229,.14); padding:40px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:40px; }

  .setup-sections { display:flex; flex-direction:column; align-items:center; justify-content:center; gap:32px; width:100%; }
  .section { width:100%; max-width:500px; background:#fff; border:1px solid #E6EEF7; border-radius:20px; padding:24px; box-shadow:0 4px 14px rgba(15,23,42,.06); text-align:center; }
  .section-title { display:flex; align-items:center; justify-content:center; gap:10px; font-weight:900; color:#0F172A; font-size:20px; letter-spacing:.01em; margin:0 0 16px; }
  .section-title svg{ width:24px; height:24px; color:#1E88E5; }

  .chips { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; }
  .chip { appearance:none; border:1px solid #CFD8DC; background:#F5F8FB; color:#0F172A; border-radius:9999px; padding:12px 18px; min-width:88px; text-align:center; font-size:18px; font-weight:800; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.05); transition:box-shadow .2s, background .2s, transform .02s; }
  .chip:hover { box-shadow:0 6px 16px rgba(30,136,229,.15); background:#E8F2FF; }
  .chip.selected { background:#1E88E5; color:#fff; border-color:#1976D2; box-shadow:0 10px 26px rgba(30,136,229,.28); }

  .setup-cta { margin-top:20px; display:flex; justify-content:center; gap:12px; }
  .setup-btn { display:inline-flex; align-items:center; gap:10px; font-size:22px; padding:14px 28px; border:none; border-radius:16px; background:#1E88E5; color:white; cursor:pointer; box-shadow:0 14px 28px rgba(30,136,229,.22); font-weight:900; letter-spacing:.02em; }
  .setup-btn:hover { background:#1976D2; box-shadow:0 18px 42px rgba(30,136,229,.3); }
  .setup-btn.secondary{ background:#ECEFF1; color:#37474F; box-shadow:none; }
  .setup-btn.secondary:hover{ background:#E0E7EE; }

  /* ====== アプリ本体 ====== */
  .header { display:flex; justify-content:space-between; align-items:center; gap:16px; margin-bottom:16px; }
  .brand { display:flex; align-items:baseline; gap:12px; }
  h1 { font-size:48px; font-weight:800; color:#1E88E5; margin:0; }
  .mode-chip { font-size:14px; font-weight:700; padding:6px 10px; border-radius:999px; border:1px solid var(--md-sys-color-outline); background:#F3F6FA; color:#1E293B; display:none; }
  .mode-chip.on { display:inline-block; }
  .progress { font-size:18px; color:#616161; }
  .question { font-size:56px; text-align:center; font-weight:700; margin-bottom:24px; }
  .timerbar-wrap { height:10px; background:#ECEFF1; border-radius:999px; overflow:hidden; border:1px solid var(--md-sys-color-outline); }
  .timerbar { height:100%; width:100%; background:linear-gradient(90deg,#1E88E5,#E53935); transform-origin:left center; transform:scaleX(1); transition:transform .1s linear; }
  .choices { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:20px; margin-top:24px; }
  button.choice { display:flex; align-items:center; justify-content:center; font-size:40px; font-weight:600; width:100%; height:140px; background:#E3F2FD; border:1px solid var(--md-sys-color-outline); border-radius:16px; cursor:pointer; transition:background-color .2s; white-space:nowrap; }
  button.choice:hover { background:#03A9F4; color:white; }
  button.choice.correct { background:var(--md-sys-color-success); color:white; }
  button.choice.wrong { background:var(--md-sys-color-error); color:white; }
  .result { font-size:44px; font-weight:800; text-align:center; min-height:1.8em; margin-top:24px; }
  .controls { text-align:center; margin-top:24px; }
  button.control { font-size:24px; font-weight:700; border:none; border-radius:12px; padding:14px 28px; color:white; background:#1E88E5; cursor:pointer; }
  button.control[disabled]{ opacity:.6; cursor:not-allowed; }

  .frac { display:inline-grid; grid-template-rows:auto auto auto; justify-items:center; align-items:center; vertical-align:middle; }
  .frac > .top,.frac > .bot { display:block; padding:0 0.18em; line-height:1.08; }
  .frac > .bar { width:100%; border-top:6px solid currentColor; margin:0.12em 0 0.1em; height:0; }

  /* Summary overlay */
  .summary-backdrop{ position: fixed; inset: 0; background: rgba(0,0,0,.32); display: none; align-items: center; justify-content: center; z-index:1000; }
  .summary-card{ background: #fff; color: #212121; border-radius: 20px; width: min(92vw, 760px); padding: 32px; border: 1px solid var(--md-sys-color-outline); box-shadow: 0 4px 12px rgba(0,0,0,.15); text-align: center; }
  .summary-title{ font-size: 36px; font-weight: 800; margin: 4px 0 8px; color:#1E88E5; }
  .summary-score{ font-size: 80px; font-weight: 900; letter-spacing: .02em; margin: 10px 0; }
  .summary-metrics{ color:#616161; font-size:18px; margin-bottom: 16px; }
  .summary-actions{ display:flex; justify-content:center; gap:12px; flex-wrap:wrap; }
  .btn{ font-size: 22px; font-weight: 700; border: none; border-radius: 12px; padding: 14px 22px; cursor: pointer; }
  .btn-primary{ background: #1E88E5; color: #fff; }
  .btn-secondary{ background: #ECEFF1; color: #263238; }

  /* Results breakdown */
  .summary-breakdown{ margin:14px auto 10px; width:min(92%,640px); }
  .summary-breakdown table{ width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid var(--md-sys-color-outline); }
  .summary-breakdown th, .summary-breakdown td{ padding:10px 12px; text-align:center; }
  .summary-breakdown thead th{ background:#F6FAFF; color:#0F172A; font-weight:900; }
  .summary-breakdown tbody tr:nth-child(even){ background:#FAFCFF; }
  .summary-note{ color:#546E7A; font-size:14px; margin-top:6px; }

  /* Advanced metrics */
  .summary-advanced{ margin:14px auto 16px; width:min(92%,680px); display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
  .stat{ border:1px solid var(--md-sys-color-outline); border-radius:12px; padding:12px; text-align:left; background:#FAFAFF; }
  .stat h4{ margin:0 0 6px; font-size:16px; color:#1E293B; }
  .stat .val{ font-size:22px; font-weight:800; color:#0F172A; }
  .stat small{ color:#607D8B; }

  /* === Celebration overlay (復習完了) === */
  .celebrate-backdrop { position: fixed; inset:0; display:none; align-items:center; justify-content:center; overflow:hidden; z-index:1100; }
  .celebrate-bg { position:absolute; inset:0; background: radial-gradient(1200px 800px at 50% -10%, #FFECB3 0%, rgba(255,236,179,0) 60%),
                                      radial-gradient(900px 700px at -10% 110%, #B3E5FC 0%, rgba(179,229,252,0) 60%),
                                      radial-gradient(900px 700px at 110% 110%, #FFCDD2 0%, rgba(255,205,210,0) 60%),
                                      linear-gradient(135deg,#E3F2FD, #FCE4EC);
                    filter: blur(0.5px); }
  .celebrate-card { position:relative; z-index:2; background: rgba(255,255,255,.85); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.6); border-radius:28px; padding:36px 32px; width:min(92vw,820px); box-shadow:0 12px 40px rgba(0,0,0,.18); text-align:center; }
  .celebrate-title { font-size:56px; font-weight:900; letter-spacing:-.02em; margin:0 0 8px; color:#1E88E5; }
  .celebrate-sub { font-size:20px; color:#37474F; margin-bottom:16px; }
  .celebrate-actions { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:16px; }
  .confetti-piece { position:absolute; width:10px; height:16px; opacity:.9; border-radius:3px; will-change: transform, opacity; }
  @keyframes confettiFall { 0% { transform: translateY(-10vh) rotate(0deg); opacity:1; } 100% { transform: translateY(110vh) rotate(720deg); opacity:0.9; } }
  .celebrate-emoji { font-size:64px; margin:10px 0 6px; }
  @media (max-width:740px){ .celebrate-title{font-size:38px} }

</style>
</head>
<body>
  <!-- セットアップ（最初に表示） -->
  <div class="container" id="setup">
    <div class="setup-screen">
      <div class="setup-hero">
        <h2 class="setup-title">TrigQuiz</h2>
        <div class="setup-sub">制限時間と問題数を選んでスタート</div>
      </div>

      <div class="setup-card">
        <div class="setup-sections">
          <div class="section" role="radiogroup" aria-label="制限時間">
            <h3 class="section-title">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 8v5l3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/></svg>
              制限時間
            </h3>
            <div class="chips" id="timeChips">
              <button class="chip" data-value="3000">3秒</button>
              <button class="chip" data-value="5000">5秒</button>
              <button class="chip" data-value="8000">8秒</button>
              <button class="chip" data-value="10000">10秒</button>
            </div>
          </div>

          <div class="section" role="radiogroup" aria-label="問題数">
            <h3 class="section-title">
              <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16M4 12h16M4 18h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
              問題数（1ブロック）
            </h3>
            <div class="chips" id="countChips">
              <button class="chip" data-value="5">5問</button>
              <button class="chip" data-value="10">10問</button>
              <button class="chip" data-value="15">15問</button>
              <button class="chip" data-value="20">20問</button>
              <button class="chip" data-value="30">30問</button>
            </div>
          </div>
        </div>
        <div class="setup-cta">
          <button id="startBtn" class="setup-btn">スタート</button>
          <button id="reviewBtn" class="setup-btn secondary" disabled>復習モードで開始</button>
        </div>
      </div>
    </div>
  </div>

  <!-- アプリ本体（開始後に表示） -->
  <div class="container" id="app" style="display:none;">
    <div class="header">
      <div class="brand">
        <h1>TrigQuiz</h1>
        <span id="modeChip" class="mode-chip">復習モード</span>
      </div>
      <div class="progress">
        <button id='backToSetup' style='font-size:16px; padding:6px 12px; border:none; border-radius:8px; background:#ECEFF1; color:#37474F; cursor:pointer;'>設定に戻る</button> | <span id="progress">0 / -</span> ・ 残り <span id="countdown">0.0</span>s</div>
    </div>
    <div id="question" class="question"></div>
    <div class="timerbar-wrap"><div id="timerbar" class="timerbar"></div></div>
    <div id="choices" class="choices"></div>
    <div id="result" class="result" aria-live="polite"></div>
    <div class="controls">
      <button id="nextBtn" class="control" disabled>次の問題へ</button>
    </div>
  </div>

  <!-- サマリー（オーバーレイ） -->
  <div class="summary-backdrop" id="summary">
    <div class="summary-card" role="dialog" aria-labelledby="summaryTitle" aria-modal="true">
      <div id="summaryTitle" class="summary-title">ブロックの結果</div>
      <div class="summary-score" id="summaryScore">0 / 0</div>
      <div class="summary-metrics" id="summaryMetrics">正答率 0% ・ 通算 0 / 0</div>
      <div class="summary-breakdown" id="summaryBreakdown"></div>
      <div class="summary-advanced" id="summaryAdvanced"></div>
      <div class="summary-note" id="summaryNote"></div>
      <div class="summary-actions">
        <button class="btn btn-secondary" id="summaryClose">閉じる</button>
        <button class="btn btn-primary" id="summaryNext">次のブロックへ</button>
        <button class="btn btn-secondary" id="summaryReview">復習モード</button>
      </div>
    </div>
  </div>

  <!-- 復習完了オーバーレイ -->
  <div class="celebrate-backdrop" id="celebrate">
    <div class="celebrate-bg" aria-hidden="true"></div>
    <div class="celebrate-card" role="dialog" aria-modal="true" aria-labelledby="celebrateTitle">
      <div class="celebrate-emoji">🎉✨</div>
      <h2 class="celebrate-title" id="celebrateTitle">復習おつかれさま！</h2>
      <div class="celebrate-sub" id="celebrateSub">苦手問題をすべて解き切りました。次は通常モードで実力試し！</div>
      <div class="celebrate-actions">
        <button class="btn btn-primary" id="celebrateContinue">通常モードで続ける</button>
        <button class="btn btn-secondary" id="celebrateSetup">ホームに戻る</button>
      </div>
    </div>
  </div>

<script>
  // ====== ユーティリティ ======
  const msToSec = (ms)=> (ms/1000).toFixed(1)+'s';
  const avg = (arr)=> arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
  const median = (arr)=>{ if(!arr.length) return 0; const s=[...arr].sort((a,b)=>a-b); const m=Math.floor(s.length/2); return s.length%2? s[m] : (s[m-1]+s[m])/2; };

  // ====== 設定チップの初期化 ======
  function initSetupUI(){
    function selectFirst(groupId){
      const group = document.getElementById(groupId);
      const first = group.querySelector('.chip');
      if(first){ first.classList.add('selected'); first.setAttribute('aria-checked','true'); }
    }
    // クリックで選択切替
    function bind(groupId){
      const group = document.getElementById(groupId);
      group.addEventListener('click', (e)=>{
        const btn = e.target.closest('.chip');
        if(!btn) return;
        group.querySelectorAll('.chip').forEach(c=>{ c.classList.remove('selected'); c.setAttribute('aria-checked','false'); });
        btn.classList.add('selected');
        btn.setAttribute('aria-checked','true');
      });
    }
    selectFirst('timeChips');
    selectFirst('countChips');
    bind('timeChips');
    bind('countChips');
  }

  // ====== クイズ本体 ======
  const MAX_MISSED = 30;

  function fracHTML(numer, denom) { return `<span class='frac'><span class='top'>${numer}</span><span class='bar'></span><span class='bot'>${denom}</span></span>`; }

  const FUNCS=['sin','cos','tan'];
  const ANGLES=[0,30,45,60,90,120,135,150,180];
  const trigValues={
    sin:{0:'0',30:fracHTML('1','2'),45:fracHTML('1','√2'),60:fracHTML('√3','2'),90:'1',120:fracHTML('√3','2'),135:fracHTML('1','√2'),150:fracHTML('1','2'),180:'0'},
    cos:{0:'1',30:fracHTML('√3','2'),45:fracHTML('1','√2'),60:fracHTML('1','2'),90:'0',120:fracHTML('-1','2'),135:fracHTML('-1','√2'),150:fracHTML('-√3','2'),180:'-1'},
    tan:{0:'0',30:fracHTML('1','√3'),45:'1',60:'√3',90:'なし',120:'-√3',135:'-1',150:fracHTML('-1','√3'),180:'0'}
  };

  const score={inBlockAnswered:0,inBlockCorrect:0,totalAnswered:0,totalCorrect:0,answeredThisQuestion:false};
  let blockStats = { sin:{asked:0,correct:0}, cos:{asked:0,correct:0}, tan:{asked:0,correct:0} };
  function resetBlockStats(){ blockStats = { sin:{asked:0,correct:0}, cos:{asked:0,correct:0}, tan:{asked:0,correct:0} }; }
  const missedSet=new Set();
  const missedBank=[];
  let reviewMode=false;
  let current={func:null,angle:null,correct:null};
  let blockRecords=[]; // {func, angle, correct:boolean, time:number(ms), outcome:'correct'|'wrong'|'timeout'}

  // 設定（開始時に上書き）
  let LIMIT_MS = 3000; // ms
  let Q_PER_BLOCK = 10; // 問題数/ブロック

  let tStart=0,tInterval=null,tTimeout=null;

  function startApp(){
    // 選択値を取得
    const tSel = document.querySelector('#timeChips .chip.selected');
    const cSel = document.querySelector('#countChips .chip.selected');
    LIMIT_MS = tSel ? Number(tSel.dataset.value) : 3000;
    Q_PER_BLOCK = cSel ? Number(cSel.dataset.value) : 10;

    // 画面切替
    document.getElementById('setup').style.display='none';
    document.getElementById('app').style.display='block';

    // 初期化
    score.inBlockAnswered=0; score.inBlockCorrect=0; score.totalAnswered=0; score.totalCorrect=0; score.answeredThisQuestion=false; resetBlockStats();
    blockRecords=[];
    document.getElementById('progress').textContent=`0 / ${Q_PER_BLOCK}`;
    document.getElementById('result').textContent='';
    updateReviewChip();
    renderQuestion();
    window.scrollTo(0,0);
  }

  function updateReviewChip(){
    const chip=document.getElementById('modeChip');
    if(chip){
      if(reviewMode){chip.classList.add('on');chip.textContent=`復習モード（残り ${missedBank.length}）`;}
      else{chip.classList.toggle('on',missedBank.length>0);chip.textContent=missedBank.length>0?`復習候補 ${missedBank.length}`:'復習モード';}
    }
    updateHomeReviewButton();
  }
  function updateHomeReviewButton(){
    const btn = document.getElementById('reviewBtn');
    if(!btn) return;
    if(missedBank.length>0){ btn.disabled=false; btn.textContent=`復習モードで開始（${missedBank.length}問）`; }
    else { btn.disabled=true; btn.textContent='復習モードで開始'; }
  }

  function startTimer(){
    stopTimer();
    tStart=performance.now();
    const bar=document.getElementById('timerbar');
    const cd=document.getElementById('countdown');
    function tick(){
      const elapsed=performance.now()-tStart;
      const remain=Math.max(0,LIMIT_MS-elapsed);
      cd.textContent=(remain/1000).toFixed(1);
      const ratio=Math.max(0,remain/LIMIT_MS);
      const r=Math.floor(30+(229-30)*(1-ratio));
      const g=Math.floor(136*ratio);
      bar.style.background=`rgb(${r},${g},229)`; // 青→赤
      bar.style.transform=`scaleX(${ratio})`;
    }
    tick();
    tInterval=setInterval(tick,100);
    tTimeout=setTimeout(timeUp,LIMIT_MS);
  }
  function stopTimer(){ if(tInterval){clearInterval(tInterval);tInterval=null;} if(tTimeout){clearTimeout(tTimeout);tTimeout=null;} }

  function updateProgress(){ document.getElementById('progress').textContent=`${score.inBlockAnswered} / ${Q_PER_BLOCK}`; }

  function timeUp(){
    if(score.answeredThisQuestion) return;
    score.answeredThisQuestion=true;
    stopTimer();

    const container=document.getElementById('choices');
    const result=document.getElementById('result');
    [...container.children].forEach(el=>{ el.disabled=true; if(el.innerHTML===current.correct) el.classList.add('correct'); });
    result.innerHTML=`⏳ 時間切れ。正解は ${current.correct}`;
    result.style.color='var(--md-sys-color-error)';

    // 記録（不正解）
    blockStats[current.func].asked++; // time up counts as asked
    addMissed(current.func,current.angle);
    blockRecords.push({func:current.func, angle:current.angle, correct:false, time:LIMIT_MS, outcome:'timeout'});

    if(!reviewMode){
      score.inBlockAnswered++; score.totalAnswered++; updateProgress();
      if(score.inBlockAnswered===Q_PER_BLOCK){ document.getElementById('nextBtn').disabled=false; showSummary(); return; }
    }
    document.getElementById('nextBtn').disabled=false;
  }

  function addMissed(func,angle){
    const key=`${func}@${angle}`;
    if(!missedSet.has(key)){
      missedSet.add(key);
      if(missedBank.length>=MAX_MISSED){missedBank.shift();}
      missedBank.push({func,angle,correct:trigValues[func][angle]});
      updateReviewChip();
    }
  }
  function removeMissed(func,angle){
    const key=`${func}@${angle}`;
    if(missedSet.has(key)){
      missedSet.delete(key);
      const idx=missedBank.findIndex(m=>m.func===func&&m.angle===angle);
      if(idx>-1)missedBank.splice(idx,1);
      updateReviewChip();
    }
  }

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

  function pickQuestion(){
    if(reviewMode){
      if(missedBank.length===0){ showReviewComplete(); return null; }
      const idx=Math.floor(Math.random()*missedBank.length); return missedBank[idx];
    }
    const func=FUNCS[Math.floor(Math.random()*FUNCS.length)];
    const angle=ANGLES[Math.floor(Math.random()*ANGLES.length)];
    return { func, angle, correct: trigValues[func][angle] };
  }

  function renderQuestion(){
    const q=pickQuestion(); if(!q) return; current=q;
    document.getElementById('question').textContent=`${q.func}(${q.angle}°) = ?`;

    let choices=[q.correct];
    while(choices.length<3){
      const rf=FUNCS[Math.floor(Math.random()*FUNCS.length)];
      const ra=ANGLES[Math.floor(Math.random()*ANGLES.length)];
      const v=trigValues[rf][ra];
      if(!choices.includes(v)) choices.push(v);
    }
    shuffle(choices);

    const ch=document.getElementById('choices'); ch.innerHTML='';
    choices.forEach(choice=>{ const b=document.createElement('button'); b.className='choice'; b.innerHTML=choice; b.onclick=()=>selectAnswer(choice,b,ch); ch.appendChild(b); });

    document.getElementById('result').textContent='';
    document.getElementById('nextBtn').disabled=true;
    score.answeredThisQuestion=false;
    startTimer();
    updateReviewChip();
  }

  function selectAnswer(selected,btn,container){
    if(score.answeredThisQuestion) return;
    score.answeredThisQuestion=true;
    stopTimer();
    const result=document.getElementById('result');

    blockStats[current.func].asked++;

    const elapsed = performance.now()-tStart;

    if(selected===current.correct){
      btn.classList.add('correct');
      result.textContent='⭕ 正解！';
      result.style.color='var(--md-sys-color-success)';
      blockStats[current.func].correct++;
      if(reviewMode){ removeMissed(current.func,current.angle); }
      else { score.inBlockCorrect++; score.totalCorrect++; }
      blockRecords.push({func:current.func, angle:current.angle, correct:true, time:elapsed, outcome:'correct'});
    } else {
      btn.classList.add('wrong');
      result.innerHTML=`❌ 不正解。正解は ${current.correct}`;
      result.style.color='var(--md-sys-color-error)';
      [...container.children].forEach(el=>{ if(el.innerHTML===current.correct) el.classList.add('correct'); });
      addMissed(current.func,current.angle);
      blockRecords.push({func:current.func, angle:current.angle, correct:false, time:elapsed, outcome:'wrong'});
    }

    [...container.children].forEach(el=> el.disabled=true);

    if(!reviewMode){
      score.inBlockAnswered++; score.totalAnswered++; updateProgress();
      if(score.inBlockAnswered===Q_PER_BLOCK){ document.getElementById('nextBtn').disabled=false; showSummary(); return; }
    }
    document.getElementById('nextBtn').disabled=false;
  }

  function nextQuestion(){ if(document.getElementById('summary').style.display==='flex') return; renderQuestion(); }

  function showSummary(){
    stopTimer();
    const pct = Q_PER_BLOCK ? Math.round((score.inBlockCorrect / Q_PER_BLOCK) * 100) : 0;
    document.getElementById('summaryTitle').textContent = `${Q_PER_BLOCK}問の結果`;
    document.getElementById('summaryScore').textContent = `${score.inBlockCorrect} / ${Q_PER_BLOCK}`;
    document.getElementById('summaryMetrics').textContent = `正答率 ${pct}% ・ 通算 ${score.totalCorrect} / ${score.totalAnswered}`;

    // 内訳表
    const b = blockStats;
    const bodyRows = [
      `<tr><td>sin</td><td>${b.sin.asked}</td><td>${b.sin.correct}</td><td>${b.sin.asked? Math.round(100*b.sin.correct/b.sin.asked)+'%':'-'}</td></tr>`,
      `<tr><td>cos</td><td>${b.cos.asked}</td><td>${b.cos.correct}</td><td>${b.cos.asked? Math.round(100*b.cos.correct/b.cos.asked)+'%':'-'}</td></tr>`,
      `<tr><td>tan</td><td>${b.tan.asked}</td><td>${b.tan.correct}</td><td>${b.tan.asked? Math.round(100*b.tan.correct/b.tan.asked)+'%':'-'}</td></tr>`
    ].join('');
    document.getElementById('summaryBreakdown').innerHTML = `
      <table>
        <thead>
          <tr><th>関数</th><th>出題数</th><th>正答数</th><th>正答率</th></tr>
        </thead>
        <tbody>${bodyRows}</tbody>
      </table>`;

    // 詳細指標
    const times = blockRecords.map(r=>r.time);
    const timesCorrect = blockRecords.filter(r=>r.correct).map(r=>r.time);
    const timesWrong = blockRecords.filter(r=>!r.correct).map(r=>r.time);
    const topMissAngles = (()=>{
      const map = new Map();
      blockRecords.filter(r=>!r.correct).forEach(r=>{
        const key = `${r.func}(${r.angle}°)`;
        map.set(key, (map.get(key)||0)+1);
      });
      return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3);
    })();
    const fastest = blockRecords.length? blockRecords.reduce((m,r)=> r.time<m.time? r:m, blockRecords[0]) : null;
    const slowest = blockRecords.length? blockRecords.reduce((m,r)=> r.time>m.time? r:m, blockRecords[0]) : null;

    const advHTML = `
      <div class="stat"><h4>平均解答時間</h4><div class="val">${msToSec(avg(times))}</div><small>中央値 ${msToSec(median(times))}</small></div>
      <div class="stat"><h4>平均（正解）</h4><div class="val">${timesCorrect.length? msToSec(avg(timesCorrect)):'-'}</div><small>${timesCorrect.length} 問</small></div>
      <div class="stat"><h4>平均（不正解/時間切れ）</h4><div class="val">${timesWrong.length? msToSec(avg(timesWrong)):'-'}</div><small>${timesWrong.length} 問</small></div>
      <div class="stat"><h4>最速回答</h4><div class="val">${fastest? msToSec(fastest.time):'-'}</div><small>${fastest? `${fastest.func}(${fastest.angle}°)` : ''}</small></div>
      <div class="stat"><h4>最も時間がかかった</h4><div class="val">${slowest? msToSec(slowest.time):'-'}</div><small>${slowest? `${slowest.func}(${slowest.angle}°)` : ''}</small></div>
      <div class="stat"><h4>誤答が多い</h4><div class="val">${topMissAngles.length? topMissAngles.map(([k,v])=>`${k} ×${v}`).join('<br/>'):'-'}</div></div>
    `;
    document.getElementById('summaryAdvanced').innerHTML = advHTML;

    document.getElementById('summaryNote').textContent = `復習候補：${missedBank.length} 問`;

    document.getElementById('summary').style.display='flex';
  }
  function closeSummary(){ document.getElementById('summary').style.display='none'; }
  function nextBlock(){ score.inBlockAnswered=0; score.inBlockCorrect=0; resetBlockStats(); blockRecords=[]; updateProgress(); renderQuestion(); }
  function startReview(){ closeSummary(); reviewMode=true; updateReviewChip(); renderQuestion(); }

  // === 復習完了の派手な画面 ===
  function showReviewComplete(){
    reviewMode=false; updateReviewChip();
    const overlay = document.getElementById('celebrate');
    overlay.style.display='flex';
    launchConfetti(140);
  }
  function closeCelebrate(){
    const overlay = document.getElementById('celebrate');
    overlay.style.display='none';
    // 残った紙吹雪を掃除
    [...document.querySelectorAll('.confetti-piece')].forEach(n=>n.remove());
  }
  function launchConfetti(n){
    const overlay = document.getElementById('celebrate');
    const colors = ['#FF5252','#FFB300','#66BB6A','#42A5F5','#AB47BC','#EC407A'];
    for(let i=0;i<n;i++){
      const d = document.createElement('div');
      d.className='confetti-piece';
      const size = 6 + Math.random()*10;
      d.style.width = size+'px';
      d.style.height = (size*1.6)+'px';
      d.style.left = Math.random()*100+'vw';
      d.style.top = (-10 - Math.random()*30)+'vh';
      d.style.background = colors[Math.floor(Math.random()*colors.length)];
      d.style.transform = `translateY(-10vh)`;
      const dur = 3 + Math.random()*2.5; // 3-5.5s
      d.style.animation = `confettiFall ${dur}s linear forwards`;
      d.style.animationDelay = (Math.random()*0.6)+'s';
      overlay.appendChild(d);
    }
  }

  // ====== 簡易スモークテスト ======
  function runSmokeTests(){
    console.group('[TrigQuiz] Smoke Tests');
    const ids = ['setup','app','summary','celebrate','startBtn','reviewBtn','nextBtn','summaryClose','summaryNext','summaryReview','celebrateContinue','celebrateSetup'];
    ids.forEach(id=> console.assert(document.getElementById(id), `Missing element: #${id}`));
    console.assert(typeof startApp === 'function', 'startApp should be defined');
    console.assert(typeof renderQuestion === 'function', 'renderQuestion should be defined');
    // 追加テストケース（値の妥当性）
    console.assert(trigValues.tan[90] === 'なし', 'tan(90°) should be なし');
    console.assert((/frac/).test(trigValues.sin[45]), 'sin(45°) should be a fraction 1/√2');
    console.groupEnd();
  }

  // イベント
  document.addEventListener('DOMContentLoaded', ()=>{
    initSetupUI();
    runSmokeTests();

    document.getElementById('startBtn').addEventListener('click', startApp);
    document.getElementById('reviewBtn').addEventListener('click', ()=>{ if(missedBank.length===0) return; reviewMode=true; startApp(); });
    document.getElementById('nextBtn').addEventListener('click', nextQuestion);
    document.getElementById('summaryClose').addEventListener('click',()=>{ closeSummary(); goHome(); });
    document.getElementById('summaryNext').addEventListener('click',()=>{
      // 次のブロックを開始（ホームへ戻らず続行・同設定）
      closeSummary();
      score.inBlockAnswered = 0; score.inBlockCorrect = 0; resetBlockStats(); blockRecords=[];
      updateProgress();
      if(document.getElementById('setup').style.display==='block'){
        document.getElementById('setup').style.display='none';
        document.getElementById('app').style.display='block';
      }
      renderQuestion();
    });
    document.getElementById('summaryReview').addEventListener('click', startReview);

    // 復習完了アクション
    const celebrateContinueBtn = document.getElementById('celebrateContinue');
    if(celebrateContinueBtn){
      celebrateContinueBtn.addEventListener('click', ()=>{ closeCelebrate(); renderQuestion(); });
    }
    const celebrateSetupBtn = document.getElementById('celebrateSetup');
    if(celebrateSetupBtn){
      celebrateSetupBtn.addEventListener('click', ()=>{ closeCelebrate(); stopTimer(); document.getElementById('app').style.display='none'; document.getElementById('setup').style.display='block'; window.scrollTo(0,0); });
    }

    document.getElementById('backToSetup').addEventListener('click',()=>{
      stopTimer();
      document.getElementById('app').style.display='none';
      document.getElementById('setup').style.display='block';
      window.scrollTo(0,0);
    });

    // キーボード: 1/2/3 で選択, Enter/N = 次, サマリー中 Enter/N/R = 復習開始
    document.addEventListener('keydown', (e)=>{
      if(document.getElementById('app').style.display!=='block') return;
      const choices=document.getElementById('choices');
      if(['1','2','3'].includes(e.key)){
        const idx=Number(e.key)-1; const btn=choices.children[idx]; if(btn) btn.click();
      }
      if(e.key==='n'||e.key==='N'||e.key==='Enter'){
        if(document.getElementById('summary').style.display==='flex') startReview();
        else if(!document.getElementById('nextBtn').disabled) nextQuestion();
      }
      if(e.key==='r'||e.key==='R'){
        if(document.getElementById('summary').style.display==='flex') startReview();
      }
    });
  });

  // ====== ホーム戻り処理 ======
  function goHome(){
    stopTimer();
    document.getElementById('app').style.display='none';
    document.getElementById('setup').style.display='block';
    updateHomeReviewButton();
    window.scrollTo(0,0);
  }
</script>
</body>
</html>
